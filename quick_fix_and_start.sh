#!/bin/bash
# –ë—ã—Å—Ç—Ä–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏ –∑–∞–ø—É—Å–∫ –≤—Å–µ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞

echo "üöÄ –ë–´–°–¢–†–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –ò –ó–ê–ü–£–°–ö"
echo "================================"

# 1. –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ–µ–∫—Ç –∏–∑ GitHub
echo "üì• –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ–µ–∫—Ç –∏–∑ GitHub..."
git pull origin main

# 2. –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Å–µ –ø—Ä–æ—Ü–µ—Å—Å—ã
echo "üõë –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Å–µ –ø—Ä–æ—Ü–µ—Å—Å—ã..."
pkill -9 python 2>/dev/null
pkill -9 python3 2>/dev/null
killall -9 python 2>/dev/null
killall -9 python3 2>/dev/null
sleep 2

# 3. –û—Å–≤–æ–±–æ–∂–¥–∞–µ–º –ø–æ—Ä—Ç 8000
echo "üîì –û—Å–≤–æ–±–æ–∂–¥–∞–µ–º –ø–æ—Ä—Ç 8000..."
lsof -ti :8000 | xargs kill -9 2>/dev/null
sleep 1

# 4. –ü—Ä–æ–≤–µ—Ä—è–µ–º .env —Ñ–∞–π–ª
echo "üìù –ü—Ä–æ–≤–µ—Ä—è–µ–º .env —Ñ–∞–π–ª..."
if [ ! -f ".env" ]; then
    echo "‚ö†Ô∏è –°–æ–∑–¥–∞–µ–º .env —Ñ–∞–π–ª..."
    cat > .env << EOF
BOT_TOKEN=your_real_bot_token_here
WEBAPP_URL=http://localhost:8000
ADMINS=1593426947
LOG_LEVEL=INFO
EOF
    echo "‚úÖ .env —Ñ–∞–π–ª —Å–æ–∑–¥–∞–Ω"
else
    echo "‚úÖ .env —Ñ–∞–π–ª —Å—É—â–µ—Å—Ç–≤—É–µ—Ç"
fi

# 5. –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–æ–∫–µ–Ω
if grep -q "your_.*_token_here" .env; then
    echo "‚ö†Ô∏è –í–ù–ò–ú–ê–ù–ò–ï: –í .env —Ñ–∞–π–ª–µ —Å—Ç–æ–∏—Ç –∑–∞–≥–ª—É—à–∫–∞ —Ç–æ–∫–µ–Ω–∞!"
    echo "üìù –ó–∞–º–µ–Ω–∏—Ç–µ 'your_real_bot_token_here' –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–π —Ç–æ–∫–µ–Ω –±–æ—Ç–∞"
    echo "ü§ñ –ü–æ–ª—É—á–∏—Ç–µ —Ç–æ–∫–µ–Ω —É @BotFather –≤ Telegram"
fi

# 6. –ó–∞–ø—É—Å–∫–∞–µ–º —Å–µ—Ä–≤–µ—Ä
echo "üöÄ –ó–∞–ø—É—Å–∫–∞–µ–º –≤–µ–±-—Å–µ—Ä–≤–µ—Ä..."
python3 perfect_server.py &
SERVER_PID=$!
sleep 3

# 7. –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–±–æ—Ç—É —Å–µ—Ä–≤–µ—Ä–∞
echo "‚úÖ –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–±–æ—Ç—É —Å–µ—Ä–≤–µ—Ä–∞..."
if curl -s http://localhost:8000 > /dev/null; then
    echo "‚úÖ –í–µ–±-—Å–µ—Ä–≤–µ—Ä —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ http://localhost:8000"
else
    echo "‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ –≤–µ–±-—Å–µ—Ä–≤–µ—Ä–∞"
    echo "üîÑ –ü—Ä–æ–±—É–µ–º –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π –ø–æ—Ä—Ç..."
    python3 perfect_server.py --port 8001 &
    SERVER_PID=$!
    sleep 3
    
    if curl -s http://localhost:8001 > /dev/null; then
        echo "‚úÖ –í–µ–±-—Å–µ—Ä–≤–µ—Ä —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ http://localhost:8001"
    else
        echo "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø—É—Å—Ç–∏—Ç—å —Å–µ—Ä–≤–µ—Ä"
        exit 1
    fi
fi

# 8. –ó–∞–ø—É—Å–∫–∞–µ–º –±–æ—Ç–∞ (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —Ç–æ–∫–µ–Ω –Ω–∞—Å—Ç—Ä–æ–µ–Ω)
if ! grep -q "your_.*_token_here" .env; then
    echo "ü§ñ –ó–∞–ø—É—Å–∫–∞–µ–º –±–æ—Ç–∞..."
    python3 bot.py &
    BOT_PID=$!
    echo "‚úÖ –ë–æ—Ç –∑–∞–ø—É—â–µ–Ω"
else
    echo "‚ö†Ô∏è –ë–æ—Ç –ù–ï –∑–∞–ø—É—â–µ–Ω - –Ω—É–∂–Ω–æ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å —Ç–æ–∫–µ–Ω –≤ .env"
    BOT_PID=""
fi

echo ""
echo "================================"
echo "‚úÖ –í–°–ï –ì–û–¢–û–í–û!"
echo ""
echo "üåê –í–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ:"
if curl -s http://localhost:8000 > /dev/null; then
    echo "   http://localhost:8000"
else
    echo "   http://localhost:8001"
fi
echo ""
if [ -n "$BOT_PID" ]; then
    echo "ü§ñ –ë–æ—Ç –∑–∞–ø—É—â–µ–Ω –∏ –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ"
else
    echo "‚ö†Ô∏è –ù–∞—Å—Ç—Ä–æ–π—Ç–µ —Ç–æ–∫–µ–Ω –≤ .env –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –±–æ—Ç–∞"
fi
echo ""
echo "üîß –ò–ù–°–¢–†–£–ö–¶–ò–Ø –ü–û –ê–î–ú–ò–ù –ü–ê–ù–ï–õ–ò:"
echo "1. –û—Ç–∫—Ä–æ–π—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≤ –ù–û–í–û–ô –≤–∫–ª–∞–¥–∫–µ –±—Ä–∞—É–∑–µ—Ä–∞"
echo "2. –û—Ç–∫—Ä–æ–π—Ç–µ –∫–æ–Ω—Å–æ–ª—å (F12) –∏ –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏:"
echo "   üöÄ –ó–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≤–µ—Ä—Å–∏–∏ 3.0"
echo "   üîß –û—Ç–ª–∞–¥–æ—á–Ω—ã–π —Ä–µ–∂–∏–º: Replit/localhost –æ–±–Ω–∞—Ä—É–∂–µ–Ω"
echo "   üëë –ê–¥–º–∏–Ω—Å–∫–∏–µ –ø—Ä–∞–≤–∞ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω—ã"
echo "3. –ê–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å –ø–æ—è–≤–∏—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏"
echo "4. –ï—Å–ª–∏ –Ω–µ –ø–æ—è–≤–∏–ª–∞—Å—å - –Ω–∞–∂–º–∏—Ç–µ –∫—Ä–∞—Å–Ω—É—é –∫–Ω–æ–ø–∫—É –≤ –ø—Ä–∞–≤–æ–º –≤–µ—Ä—Ö–Ω–µ–º —É–≥–ª—É"
echo ""
echo "üõë –î–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏: Ctrl+C"
echo "================================"

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
cleanup() {
    echo ""
    echo "üõë –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–µ—Ä–≤–∏—Å—ã..."
    if [ -n "$SERVER_PID" ]; then
        kill $SERVER_PID 2>/dev/null
    fi
    if [ -n "$BOT_PID" ]; then
        kill $BOT_PID 2>/dev/null
    fi
    echo "‚úÖ –í—Å–µ —Å–µ—Ä–≤–∏—Å—ã –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã"
    exit 0
}

# –ü–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–µ–º —Å–∏–≥–Ω–∞–ª –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
trap cleanup INT TERM

# –ñ–¥–µ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
wait
