#!/bin/bash

# ===============================================
# ๐ ะะะะซะ ะกะะะะะข ะะะะะะะะะะฏ - ะะะะกะขะะ ะ ะะะะะะะซะ
# ===============================================

# ะคัะฝะบัะธั ะดะปั ะฒัะฒะพะดะฐ ัะพะพะฑัะตะฝะธะน
log() {
    echo "โ $1"
}

error() {
    echo "โ $1" >&2
}

warning() {
    echo "โ๏ธ $1"
}

echo "๐ ะะะะะ ะะะะะะะะะะ ะะะะะะขะ"
echo "=================================="

# 1. ะััะฐะฝะฐะฒะปะธะฒะฐะตะผ ะฒัะต ะฟัะพัะตััั Python
echo "๐ ะััะฐะฝะฐะฒะปะธะฒะฐะตะผ ะฟัะพัะตััั..."
pkill -9 python 2>/dev/null || true
pkill -9 python3 2>/dev/null || true
sleep 2

# 2. ะัะฒะพะฑะพะถะดะฐะตะผ ะฟะพัั 8000
echo "๐ ะัะฒะพะฑะพะถะดะฐะตะผ ะฟะพัั 8000..."
if command -v lsof &> /dev/null; then
    lsof -ti:8000 | xargs kill -9 2>/dev/null || true
elif command -v fuser &> /dev/null; then
    fuser -k 8000/tcp 2>/dev/null || true
fi
sleep 1

# 3. ะะฑะฝะพะฒะปัะตะผ ะฟัะพะตะบั ั GitHub
echo "๐ฅ ะะฑะฝะพะฒะปัะตะผ ั GitHub..."
git pull origin main

# 4. ะัะพะฒะตััะตะผ .env ัะฐะนะป
echo "๐ ะัะพะฒะตััะตะผ .env ัะฐะนะป..."
if [ ! -f ".env" ]; then
    warning "ะกะพะทะดะฐะตะผ .env ัะฐะนะป..."
    cat > .env << EOF
BOT_TOKEN=your_real_bot_token_here
WEBAPP_URL=http://localhost:8000
ADMINS=1593426947
LOG_LEVEL=INFO
EOF
    log ".env ัะฐะนะป ัะพะทะดะฐะฝ"
else
    log ".env ัะฐะนะป ัััะตััะฒัะตั"
fi

# 5. ะัะพะฒะตััะตะผ ะฑะฐะทั ะดะฐะฝะฝัั
echo "๐พ ะัะพะฒะตััะตะผ ะฑะฐะทั ะดะฐะฝะฝัั..."
if [ ! -f "shop.db" ]; then
    warning "ะะฐะทะฐ ะดะฐะฝะฝัั ะฝะต ะฝะฐะนะดะตะฝะฐ, ะธะฝะธัะธะฐะปะธะทะธััะตะผ..."
    python3 -c "
from database import Database
try:
    db = Database()
    db.init_database()
    print('โ ะะฐะทะฐ ะดะฐะฝะฝัั ะธะฝะธัะธะฐะปะธะทะธัะพะฒะฐะฝะฐ')
except Exception as e:
    print(f'โ๏ธ ะัะธะฑะบะฐ ะธะฝะธัะธะฐะปะธะทะฐัะธะธ ะะ: {e}')
" 2>/dev/null || warning "ะะต ัะดะฐะปะพัั ะธะฝะธัะธะฐะปะธะทะธัะพะฒะฐัั ะะ"
else
    log "ะะฐะทะฐ ะดะฐะฝะฝัั ัััะตััะฒัะตั"
fi

# 6. ะะฐะฟััะบะฐะตะผ ัะตัะฒะตั ะฒ ัะพะฝะต
echo "๐ ะะฐะฟััะบะฐะตะผ ัะตัะฒะตั..."
python3 perfect_server.py > server.log 2>&1 &
SERVER_PID=$!
log "ะกะตัะฒะตั ะทะฐะฟััะตะฝ ั PID: $SERVER_PID"

# 7. ะะดะตะผ ะทะฐะฟััะบะฐ ัะตัะฒะตัะฐ
echo "โณ ะะดะตะผ ะทะฐะฟััะบะฐ ัะตัะฒะตัะฐ..."
sleep 5

# 8. ะัะพะฒะตััะตะผ ัะฐะฑะพัั ัะตัะฒะตัะฐ
echo "๐ ะัะพะฒะตััะตะผ ัะตัะฒะตั..."
if curl -s http://localhost:8000 > /dev/null 2>&1; then
    log "ะกะตัะฒะตั ัะฐะฑะพัะฐะตั ะฝะฐ http://localhost:8000"
else
    error "ะกะตัะฒะตั ะฝะต ะพัะฒะตัะฐะตั!"
    echo "๐ ะะพะณะธ ัะตัะฒะตัะฐ:"
    tail -10 server.log 2>/dev/null || echo "ะะพะณะธ ะฝะตะดะพัััะฟะฝั"
    exit 1
fi

# 9. ะะฐะฟััะบะฐะตะผ ะฑะพัะฐ ะฒ ัะพะฝะต
echo "๐ค ะะฐะฟััะบะฐะตะผ ะฑะพัะฐ..."
python3 main.py > bot.log 2>&1 &
BOT_PID=$!
log "ะะพั ะทะฐะฟััะตะฝ ั PID: $BOT_PID"

# 10. ะคะธะฝะฐะปัะฝะฐั ะฟัะพะฒะตัะบะฐ
echo "๐ ะคะธะฝะฐะปัะฝะฐั ะฟัะพะฒะตัะบะฐ..."
sleep 2

if curl -s http://localhost:8000 > /dev/null 2>&1; then
    log "โ ะะกะ ะะะขะะะ!"
    echo ""
    echo "๐ ะะะะะะะะะะ ะะะะะะจะะะ!"
    echo "=================================="
    echo "๐ ะะตะฑ-ะฟัะธะปะพะถะตะฝะธะต: http://localhost:8000"
    echo "๐ค ะะพั ะทะฐะฟััะตะฝ"
    echo "๐พ ะะฐะทะฐ ะดะฐะฝะฝัั: shop.db"
    echo "๐ ะะดะผะธะฝ: ะฝะฐะถะผะธัะต ะทะตะปะตะฝัั ะบะฝะพะฟะบั '๐ ะะดะผะธะฝ' ะฒ ะฝะฐะฒะธะณะฐัะธะธ"
    echo ""
    echo "๐ ะกัะฐััั:"
    echo "   ะกะตัะฒะตั PID: $SERVER_PID"
    echo "   ะะพั PID: $BOT_PID"
    echo ""
    echo "๐ ะะปั ะพััะฐะฝะพะฒะบะธ:"
    echo "   kill $SERVER_PID $BOT_PID"
    echo "=================================="
else
    error "ะงัะพ-ัะพ ะฟะพัะปะพ ะฝะต ัะฐะบ!"
    exit 1
fi
