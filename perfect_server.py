#!/usr/bin/env python3
"""
–ò–î–ï–ê–õ–¨–ù–´–ô –°–ï–†–í–ï–† - –ü–æ–ª–Ω–æ—Å—Ç—å—é –ø–µ—Ä–µ–¥–µ–ª–∞–Ω–Ω–∞—è –ª–æ–≥–∏–∫–∞ —Å –Ω—É–ª—è
–ì–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ —Ä–∞–±–æ—Ç–∞—é—â–∏–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –∏ —É–¥–∞–ª–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–æ–≤
"""

import http.server
import socketserver
import json
import os
import sqlite3
from urllib.parse import urlparse, parse_qs
from datetime import datetime

PORT = 8000
DB_PATH = "shop.db"

class ProductManager:
    """–ú–µ–Ω–µ–¥–∂–µ—Ä —Ç–æ–≤–∞—Ä–æ–≤ - —Ä–∞–±–æ—Ç–∞ —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö"""
    
    def __init__(self, db_path):
        self.db_path = db_path
        self.init_database()
    
    def init_database(self):
        """–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö"""
        with sqlite3.connect(self.db_path) as conn:
            cursor = conn.cursor()
            cursor.execute("""
                CREATE TABLE IF NOT EXISTS products (
                    id INTEGER PRIMARY KEY AUTOINCREMENT,
                    title TEXT NOT NULL,
                    description TEXT,
                    price REAL NOT NULL,
                    sizes TEXT,
                    photo TEXT,
                    is_active INTEGER DEFAULT 1,
                    created_at TEXT
                )
            """)
            conn.commit()
            print("‚úÖ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞")
    
    def get_all_products(self, active_only=True):
        """–ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ —Ç–æ–≤–∞—Ä—ã"""
        with sqlite3.connect(self.db_path) as conn:
            conn.row_factory = sqlite3.Row
            cursor = conn.cursor()
            
            if active_only:
                cursor.execute("SELECT * FROM products WHERE is_active = 1 ORDER BY id DESC")
            else:
                cursor.execute("SELECT * FROM products ORDER BY id DESC")
            
            rows = cursor.fetchall()
            products = []
            
            for row in rows:
                product = {
                    "id": row["id"],
                    "title": row["title"],
                    "description": row["description"],
                    "price": row["price"],
                    "sizes": json.loads(row["sizes"]) if row["sizes"] else [],
                    "photo": row["photo"],
                    "is_active": bool(row["is_active"])
                }
                products.append(product)
            
            print(f"üì¶ –ó–∞–≥—Ä—É–∂–µ–Ω–æ —Ç–æ–≤–∞—Ä–æ–≤: {len(products)}")
            return products
    
    def get_product_by_id(self, product_id):
        """–ü–æ–ª—É—á–∏—Ç—å —Ç–æ–≤–∞—Ä –ø–æ ID"""
        with sqlite3.connect(self.db_path) as conn:
            conn.row_factory = sqlite3.Row
            cursor = conn.cursor()
            cursor.execute("SELECT * FROM products WHERE id = ?", (product_id,))
            row = cursor.fetchone()
            
            if not row:
                return None
            
            return {
                "id": row["id"],
                "title": row["title"],
                "description": row["description"],
                "price": row["price"],
                "sizes": json.loads(row["sizes"]) if row["sizes"] else [],
                "photo": row["photo"],
                "is_active": bool(row["is_active"])
            }
    
    def add_product(self, title, description, price, sizes, photo="/webapp/static/uploads/default.jpg"):
        """–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π —Ç–æ–≤–∞—Ä"""
        with sqlite3.connect(self.db_path) as conn:
            cursor = conn.cursor()
            cursor.execute("""
                INSERT INTO products (title, description, price, sizes, photo, is_active, created_at)
                VALUES (?, ?, ?, ?, ?, 1, ?)
            """, (
                title,
                description,
                price,
                json.dumps(sizes),
                photo,
                datetime.now().isoformat()
            ))
            conn.commit()
            product_id = cursor.lastrowid
            print(f"‚úÖ –¢–æ–≤–∞—Ä –¥–æ–±–∞–≤–ª–µ–Ω: ID={product_id}, {title}")
            return product_id
    
    def update_product(self, product_id, title=None, description=None, price=None, sizes=None, photo=None):
        """–û–±–Ω–æ–≤–∏—Ç—å —Ç–æ–≤–∞—Ä"""
        product = self.get_product_by_id(product_id)
        if not product:
            print(f"‚ùå –¢–æ–≤–∞—Ä ID={product_id} –Ω–µ –Ω–∞–π–¥–µ–Ω")
            return False
        
        with sqlite3.connect(self.db_path) as conn:
            cursor = conn.cursor()
            
            updates = []
            params = []
            
            if title is not None:
                updates.append("title = ?")
                params.append(title)
            if description is not None:
                updates.append("description = ?")
                params.append(description)
            if price is not None:
                updates.append("price = ?")
                params.append(price)
            if sizes is not None:
                updates.append("sizes = ?")
                params.append(json.dumps(sizes))
            if photo is not None:
                updates.append("photo = ?")
                params.append(photo)
            
            if not updates:
                return True
            
            params.append(product_id)
            query = f"UPDATE products SET {', '.join(updates)} WHERE id = ?"
            
            cursor.execute(query, params)
            conn.commit()
            print(f"‚úÖ –¢–æ–≤–∞—Ä –æ–±–Ω–æ–≤–ª–µ–Ω: ID={product_id}")
            return True
    
    def delete_product(self, product_id):
        """–£–¥–∞–ª–∏—Ç—å —Ç–æ–≤–∞—Ä (–º—è–≥–∫–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ)"""
        product = self.get_product_by_id(product_id)
        if not product:
            print(f"‚ùå –¢–æ–≤–∞—Ä ID={product_id} –Ω–µ –Ω–∞–π–¥–µ–Ω")
            return False
        
        with sqlite3.connect(self.db_path) as conn:
            cursor = conn.cursor()
            cursor.execute("UPDATE products SET is_active = 0 WHERE id = ?", (product_id,))
            conn.commit()
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
            cursor.execute("SELECT is_active FROM products WHERE id = ?", (product_id,))
            result = cursor.fetchone()
            
            if result and result[0] == 0:
                print(f"‚úÖ –¢–æ–≤–∞—Ä —É–¥–∞–ª–µ–Ω: ID={product_id}, {product['title']}")
                return True
            else:
                print(f"‚ùå –û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Ç–æ–≤–∞—Ä–∞ ID={product_id}")
                return False

# –ì–ª–æ–±–∞–ª—å–Ω—ã–π –º–µ–Ω–µ–¥–∂–µ—Ä —Ç–æ–≤–∞—Ä–æ–≤
product_manager = ProductManager(DB_PATH)

class PerfectHandler(http.server.SimpleHTTPRequestHandler):
    """–ò–¥–µ–∞–ª—å–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∑–∞–ø—Ä–æ—Å–æ–≤"""
    
    def end_headers(self):
        # CORS –∑–∞–≥–æ–ª–æ–≤–∫–∏ –¥–ª—è –≤—Å–µ—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
        self.send_header('Access-Control-Allow-Origin', '*')
        self.send_header('Access-Control-Allow-Methods', 'GET, POST, PUT, DELETE, OPTIONS')
        self.send_header('Access-Control-Allow-Headers', 'Content-Type, Authorization')
        super().end_headers()
    
    def do_OPTIONS(self):
        """–û–±—Ä–∞–±–æ—Ç–∫–∞ preflight –∑–∞–ø—Ä–æ—Å–æ–≤"""
        self.send_response(200)
        self.end_headers()
    
    def send_json(self, status_code, data):
        """–û—Ç–ø—Ä–∞–≤–∏—Ç—å JSON –æ—Ç–≤–µ—Ç"""
        self.send_response(status_code)
        self.send_header('Content-type', 'application/json; charset=utf-8')
        self.end_headers()
        self.wfile.write(json.dumps(data, ensure_ascii=False).encode('utf-8'))
    
    def do_GET(self):
        """–û–±—Ä–∞–±–æ—Ç–∫–∞ GET –∑–∞–ø—Ä–æ—Å–æ–≤"""
        print(f"üì• GET {self.path}")
        
        # –ì–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞
        if self.path == '/' or self.path == '/webapp/index_clean.html':
            self.send_response(200)
            self.send_header('Content-type', 'text/html; charset=utf-8')
            self.end_headers()
            try:
                with open('webapp/index_clean.html', 'r', encoding='utf-8') as f:
                    self.wfile.write(f.read().encode('utf-8'))
            except:
                self.wfile.write('<h1>–°–µ—Ä–≤–µ—Ä —Ä–∞–±–æ—Ç–∞–µ—Ç!</h1>'.encode('utf-8'))
            return
        
        # API: –ü–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ —Ç–æ–≤–∞—Ä–æ–≤
        elif self.path == '/webapp/products.json' or self.path == '/api/products':
            products = product_manager.get_all_products(active_only=True)
            self.send_json(200, products)
            return
        
        # API: –ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ —Ç–æ–≤–∞—Ä—ã (–¥–ª—è –∞–¥–º–∏–Ω–∞)
        elif self.path.startswith('/webapp/admin/products'):
            products = product_manager.get_all_products(active_only=False)
            self.send_json(200, {"products": products})
            return
        
        # –°—Ç–∞—Ç–∏—á–µ—Å–∫–∏–µ —Ñ–∞–π–ª—ã
        else:
            super().do_GET()
    
    def do_POST(self):
        """–û–±—Ä–∞–±–æ—Ç–∫–∞ POST –∑–∞–ø—Ä–æ—Å–æ–≤ - –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞"""
        print(f"üì• POST {self.path}")
        
        if self.path == '/webapp/admin/products' or self.path == '/api/admin/products':
            try:
                # –ß–∏—Ç–∞–µ–º –¥–∞–Ω–Ω—ã–µ
                content_length = int(self.headers.get('Content-Length', 0))
                post_data = self.rfile.read(content_length)
                
                # –ü–∞—Ä—Å–∏–º JSON
                data = json.loads(post_data.decode('utf-8'))
                
                # –ò–∑–≤–ª–µ–∫–∞–µ–º –¥–∞–Ω–Ω—ã–µ
                title = data.get('title', '–ù–æ–≤—ã–π —Ç–æ–≤–∞—Ä')
                description = data.get('description', '')
                price = float(data.get('price', 1000))
                sizes = data.get('sizes', ['M', 'L'])
                photo = data.get('photo', '/webapp/static/uploads/default.jpg')
                
                # –î–æ–±–∞–≤–ª—è–µ–º —Ç–æ–≤–∞—Ä
                product_id = product_manager.add_product(title, description, price, sizes, photo)
                
                self.send_json(200, {
                    "success": True,
                    "product_id": product_id,
                    "message": "–¢–æ–≤–∞—Ä —Å–æ–∑–¥–∞–Ω —É—Å–ø–µ—à–Ω–æ"
                })
                
            except Exception as e:
                print(f"‚ùå –û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ç–æ–≤–∞—Ä–∞: {e}")
                self.send_json(500, {"success": False, "error": str(e)})
        else:
            self.send_json(404, {"success": False, "error": "Not found"})
    
    def do_PUT(self):
        """–û–±—Ä–∞–±–æ—Ç–∫–∞ PUT –∑–∞–ø—Ä–æ—Å–æ–≤ - —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞"""
        print(f"üì• PUT {self.path}")
        
        if self.path.startswith('/webapp/admin/products/'):
            try:
                # –ò–∑–≤–ª–µ–∫–∞–µ–º ID —Ç–æ–≤–∞—Ä–∞
                path_parts = self.path.split('/')
                product_id = int(path_parts[-1].split('?')[0])
                
                # –ß–∏—Ç–∞–µ–º –¥–∞–Ω–Ω—ã–µ
                content_length = int(self.headers.get('Content-Length', 0))
                post_data = self.rfile.read(content_length)
                
                # –ü–∞—Ä—Å–∏–º JSON
                data = json.loads(post_data.decode('utf-8'))
                
                # –û–±–Ω–æ–≤–ª—è–µ–º —Ç–æ–≤–∞—Ä
                success = product_manager.update_product(
                    product_id,
                    title=data.get('title'),
                    description=data.get('description'),
                    price=data.get('price'),
                    sizes=data.get('sizes'),
                    photo=data.get('photo')
                )
                
                if success:
                    self.send_json(200, {"success": True, "message": "–¢–æ–≤–∞—Ä –æ–±–Ω–æ–≤–ª–µ–Ω —É—Å–ø–µ—à–Ω–æ"})
                else:
                    self.send_json(404, {"success": False, "error": "–¢–æ–≤–∞—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω"})
                
            except Exception as e:
                print(f"‚ùå –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–æ–≤–∞—Ä–∞: {e}")
                self.send_json(500, {"success": False, "error": str(e)})
        else:
            self.send_json(404, {"success": False, "error": "Not found"})
    
    def do_DELETE(self):
        """–û–±—Ä–∞–±–æ—Ç–∫–∞ DELETE –∑–∞–ø—Ä–æ—Å–æ–≤ - —É–¥–∞–ª–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞"""
        print(f"üì• DELETE {self.path}")
        
        if self.path.startswith('/webapp/admin/products/'):
            try:
                # –ò–∑–≤–ª–µ–∫–∞–µ–º ID —Ç–æ–≤–∞—Ä–∞
                path_parts = self.path.split('/')
                product_id_str = path_parts[-1].split('?')[0]
                product_id = int(product_id_str)
                
                print(f"üóëÔ∏è –£–¥–∞–ª—è–µ–º —Ç–æ–≤–∞—Ä ID={product_id}")
                
                # –£–¥–∞–ª—è–µ–º —Ç–æ–≤–∞—Ä
                success = product_manager.delete_product(product_id)
                
                if success:
                    self.send_json(200, {"success": True, "message": "–¢–æ–≤–∞—Ä —É–¥–∞–ª–µ–Ω —É—Å–ø–µ—à–Ω–æ"})
                else:
                    self.send_json(404, {"success": False, "error": "–¢–æ–≤–∞—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω"})
                
            except Exception as e:
                print(f"‚ùå –û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Ç–æ–≤–∞—Ä–∞: {e}")
                import traceback
                traceback.print_exc()
                self.send_json(500, {"success": False, "error": str(e)})
        else:
            self.send_json(404, {"success": False, "error": "Not found"})

def start_server():
    """–ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–µ—Ä–∞"""
    print("=" * 60)
    print("üöÄ –ò–î–ï–ê–õ–¨–ù–´–ô –°–ï–†–í–ï–†")
    print("=" * 60)
    print(f"üì± –ê–¥—Ä–µ—Å: http://localhost:{PORT}")
    print(f"üíæ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö: {DB_PATH}")
    
    # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ
    products = product_manager.get_all_products(active_only=False)
    print(f"üõçÔ∏è –¢–æ–≤–∞—Ä–æ–≤ –≤ —Å–∏—Å—Ç–µ–º–µ: {len(products)}")
    print("=" * 60)
    
    with socketserver.TCPServer(("0.0.0.0", PORT), PerfectHandler) as httpd:
        try:
            print("‚úÖ –°–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω —É—Å–ø–µ—à–Ω–æ!")
            httpd.serve_forever()
        except KeyboardInterrupt:
            print("\nüõë –°–µ—Ä–≤–µ—Ä –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω")

if __name__ == "__main__":
    start_server()

