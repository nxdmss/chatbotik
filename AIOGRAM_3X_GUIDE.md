# ü§ñ –ì–∞–π–¥ –ø–æ –æ—Å–Ω–æ–≤–∞–º AIOgram 3.x

–ü–æ–ª–Ω—ã–π –≥–∞–π–¥ –¥–ª—è –Ω–∞—á–∏–Ω–∞—é—â–∏—Ö –ø–æ –≤—Å–µ–º –æ—Å–Ω–æ–≤–Ω—ã–º –∞—Å–ø–µ–∫—Ç–∞–º —Ä–∞–±–æ—Ç—ã —Å AIOgram 3.x, –≤–∫–ª—é—á–∞—è –ø—Ä–∏–º–µ—Ä—ã –∫–æ–¥–∞ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Ä–∞–±–æ—á–µ–≥–æ –±–æ—Ç–∞.

---

## üìã –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ

1. [–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ AIOgram](#1-—É—Å—Ç–∞–Ω–æ–≤–∫–∞-–∏-–Ω–∞—Å—Ç—Ä–æ–π–∫–∞-aiogram)
2. [–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –±–æ—Ç–∞ –≤ Telegram](#2-—Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è-–±–æ—Ç–∞-–≤-telegram)
3. [–†–∞–±–æ—Ç–∞ —Å Dispatcher –∏ Router](#3-—Ä–∞–±–æ—Ç–∞-—Å-dispatcher-–∏-router)
4. [–û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π –∏ –∫–æ–º–∞–Ω–¥](#4-–æ–±—Ä–∞–±–æ—Ç–∫–∞-—Å–æ–æ–±—â–µ–Ω–∏–π-–∏-–∫–æ–º–∞–Ω–¥)
5. [–ú–∞—à–∏–Ω–∞ —Å–æ—Å—Ç–æ—è–Ω–∏–π (FSM)](#5-–º–∞—à–∏–Ω–∞-—Å–æ—Å—Ç–æ—è–Ω–∏–π-fsm)
6. [–†–∞–±–æ—Ç–∞ —Å Inline-–∫–Ω–æ–ø–∫–∞–º–∏ –∏ –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞–º–∏](#6-—Ä–∞–±–æ—Ç–∞-—Å-inline-–∫–Ω–æ–ø–∫–∞–º–∏-–∏-–∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞–º–∏)
7. [–§–∏–ª—å—Ç—Ä—ã —Å–æ–æ–±—â–µ–Ω–∏–π](#7-—Ñ–∏–ª—å—Ç—Ä—ã-—Å–æ–æ–±—â–µ–Ω–∏–π)
8. [Middleware](#8-middleware)
9. [–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö](#9-–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ-–±–∞–∑—ã-–¥–∞–Ω–Ω—ã—Ö)
10. [–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫](#10-–ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ-–∏-–æ–±—Ä–∞–±–æ—Ç–∫–∞-–æ—à–∏–±–æ–∫)
11. [–†–∞–∑–≤—ë—Ä—Ç—ã–≤–∞–Ω–∏–µ –±–æ—Ç–∞](#11-—Ä–∞–∑–≤—ë—Ä—Ç—ã–≤–∞–Ω–∏–µ-–±–æ—Ç–∞)
12. [–ü—Ä–∏–º–µ—Ä—ã –≥–æ—Ç–æ–≤—ã—Ö –±–æ—Ç–æ–≤](#12-–ø—Ä–∏–º–µ—Ä—ã-–≥–æ—Ç–æ–≤—ã—Ö-–±–æ—Ç–æ–≤)

---

## 1. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ AIOgram

### –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ —á–µ—Ä–µ–∑ pip

AIOgram 3.x —Ç—Ä–µ–±—É–µ—Ç Python 3.8 –∏–ª–∏ –≤—ã—à–µ. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –±–∏–±–ª–∏–æ—Ç–µ–∫—É —Å –ø–æ–º–æ—â—å—é pip:

```bash
pip install aiogram==3.3.0
```

–î–ª—è —Ä–∞–±–æ—Ç—ã —Å —Å–æ—Å—Ç–æ—è–Ω–∏—è–º–∏ (FSM) —Ç–∞–∫–∂–µ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ:

```bash
pip install aiofiles
```

### –ù–∞—á–∞–ª—å–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞

–°–æ–∑–¥–∞–π—Ç–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—É –ø—Ä–æ–µ–∫—Ç–∞:

```bash
my_bot/
‚îú‚îÄ‚îÄ bot.py           # –ì–ª–∞–≤–Ω—ã–π —Ñ–∞–π–ª –±–æ—Ç–∞
‚îú‚îÄ‚îÄ config.py        # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
‚îú‚îÄ‚îÄ handlers/        # –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îú‚îÄ‚îÄ commands.py
‚îÇ   ‚îî‚îÄ‚îÄ messages.py
‚îú‚îÄ‚îÄ keyboards/       # –ö–ª–∞–≤–∏–∞—Ç—É—Ä—ã
‚îÇ   ‚îî‚îÄ‚îÄ __init__.py
‚îú‚îÄ‚îÄ middlewares/     # Middleware
‚îÇ   ‚îî‚îÄ‚îÄ __init__.py
‚îî‚îÄ‚îÄ requirements.txt
```

–°–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª `requirements.txt`:

```txt
aiogram==3.3.0
aiofiles==23.2.1
python-dotenv==1.0.0
```

---

## 2. –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –±–æ—Ç–∞ –≤ Telegram

### –ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞ —á–µ—Ä–µ–∑ BotFather

1. –û—Ç–∫—Ä–æ–π—Ç–µ Telegram –∏ –Ω–∞–π–¥–∏—Ç–µ –±–æ—Ç–∞ [@BotFather](https://t.me/BotFather)
2. –û—Ç–ø—Ä–∞–≤—å—Ç–µ –∫–æ–º–∞–Ω–¥—É `/newbot`
3. –í–≤–µ–¥–∏—Ç–µ –∏–º—è –±–æ—Ç–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, "My Awesome Bot")
4. –í–≤–µ–¥–∏—Ç–µ username –±–æ—Ç–∞ (–¥–æ–ª–∂–µ–Ω –∑–∞–∫–∞–Ω—á–∏–≤–∞—Ç—å—Å—è –Ω–∞ `bot`, –Ω–∞–ø—Ä–∏–º–µ—Ä, `my_awesome_bot`)
5. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ –ø–æ–ª—É—á–µ–Ω–Ω—ã–π —Ç–æ–∫–µ–Ω (—Ñ–æ—Ä–º–∞—Ç: `123456789:ABCdefGHIjklMNOpqrsTUVwxyz`)

### –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ç–æ–∫–µ–Ω–∞ –≤ –∫–æ–¥–µ

–°–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª `.env` –≤ –∫–æ—Ä–Ω–µ –ø—Ä–æ–µ–∫—Ç–∞:

```env
BOT_TOKEN=123456789:ABCdefGHIjklMNOpqrsTUVwxyz
```

–°–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª `config.py`:

```python
import os
from dotenv import load_dotenv

load_dotenv()

BOT_TOKEN = os.getenv('BOT_TOKEN')

if not BOT_TOKEN:
    raise ValueError("BOT_TOKEN –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è!")
```

---

## 3. –†–∞–±–æ—Ç–∞ —Å Dispatcher –∏ Router

### –ó–∞—á–µ–º –Ω—É–∂–µ–Ω –¥–∏—Å–ø–µ—Ç—á–µ—Ä

**Dispatcher** ‚Äî —ç—Ç–æ —Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω—ã–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç AIOgram, –∫–æ—Ç–æ—Ä—ã–π:
- –£–ø—Ä–∞–≤–ª—è–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –≤—Å–µ—Ö –≤—Ö–æ–¥—è—â–∏—Ö –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π
- –ú–∞—Ä—à—Ä—É—Ç–∏–∑–∏—Ä—É–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –∫ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞–º
- –£–ø—Ä–∞–≤–ª—è–µ—Ç middleware –∏ —Ñ–∏–ª—å—Ç—Ä–∞–º–∏

–í AIOgram 3.x dispatcher —Ä–∞–±–æ—Ç–∞–µ—Ç —Å–æ–≤–º–µ—Å—Ç–Ω–æ —Å **Router** –¥–ª—è –º–æ–¥—É–ª—å–Ω–æ–π –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ –∫–æ–¥–∞.

### –ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Router –¥–ª—è –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏–π

**Router** –ø–æ–∑–≤–æ–ª—è–µ—Ç –æ—Ä–≥–∞–Ω–∏–∑–æ–≤–∞—Ç—å –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –ø–æ –º–æ–¥—É–ª—è–º:

```python
# bot.py
import asyncio
import logging
from aiogram import Bot, Dispatcher
from aiogram.enums import ParseMode
from config import BOT_TOKEN

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
logging.basicConfig(level=logging.INFO)

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–æ—Ç–∞ –∏ –¥–∏—Å–ø–µ—Ç—á–µ—Ä–∞
bot = Bot(token=BOT_TOKEN, parse_mode=ParseMode.HTML)
dp = Dispatcher()

async def main():
    # –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞
    await dp.start_polling(bot)

if __name__ == "__main__":
    asyncio.run(main())
```

–ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è Router:

```python
# handlers/commands.py
from aiogram import Router
from aiogram.filters import CommandStart
from aiogram.types import Message

router = Router()

@router.message(CommandStart())
async def cmd_start(message: Message):
    await message.answer("–ü—Ä–∏–≤–µ—Ç! –Ø –±–æ—Ç –Ω–∞ AIOgram 3.x")
```

–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —Ä–æ—É—Ç–µ—Ä–∞ –≤ –≥–ª–∞–≤–Ω–æ–º —Ñ–∞–π–ª–µ:

```python
# bot.py
from handlers import commands

# –ü–æ–¥–∫–ª—é—á–∞–µ–º —Ä–æ—É—Ç–µ—Ä
dp.include_router(commands.router)
```

---

## 4. –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π –∏ –∫–æ–º–∞–Ω–¥

### –°–æ–∑–¥–∞–Ω–∏–µ —Ö—ç–Ω–¥–ª–µ—Ä–æ–≤ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π

–í AIOgram 3.x –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–∑–¥–∞—é—Ç—Å—è —Å –ø–æ–º–æ—â—å—é –¥–µ–∫–æ—Ä–∞—Ç–æ—Ä–æ–≤:

```python
from aiogram import Router, F
from aiogram.types import Message

router = Router()

# –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
@router.message(F.text)
async def handle_text(message: Message):
    await message.answer(f"–í—ã –Ω–∞–ø–∏—Å–∞–ª–∏: {message.text}")

# –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–æ—Ç–æ
@router.message(F.photo)
async def handle_photo(message: Message):
    await message.answer("–°–ø–∞—Å–∏–±–æ –∑–∞ —Ñ–æ—Ç–æ!")

# –û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
@router.message(F.document)
async def handle_document(message: Message):
    await message.answer(f"–ü–æ–ª—É—á–µ–Ω –¥–æ–∫—É–º–µ–Ω—Ç: {message.document.file_name}")
```

### –ü—Ä–∏–º–µ—Ä –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∫–æ–º–∞–Ω–¥—ã `/start`

```python
from aiogram import Router
from aiogram.filters import CommandStart, Command
from aiogram.types import Message

router = Router()

@router.message(CommandStart())
async def cmd_start(message: Message):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /start"""
    await message.answer(
        f"üëã –ü—Ä–∏–≤–µ—Ç, {message.from_user.first_name}!\n\n"
        "–Ø –±–æ—Ç –Ω–∞ AIOgram 3.x. –í–æ—Ç –º–æ–∏ –∫–æ–º–∞–Ω–¥—ã:\n"
        "/help - –ü–æ–º–æ—â—å\n"
        "/about - –û –±–æ—Ç–µ"
    )

@router.message(Command("help"))
async def cmd_help(message: Message):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /help"""
    await message.answer(
        "üìñ –°–ø—Ä–∞–≤–∫–∞ –ø–æ –±–æ—Ç—É:\n\n"
        "–ü—Ä–æ—Å—Ç–æ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –º–Ω–µ —Å–æ–æ–±—â–µ–Ω–∏–µ, –∏ —è –æ—Ç–≤–µ—á—É!"
    )

@router.message(Command("about"))
async def cmd_about(message: Message):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /about"""
    await message.answer(
        "‚ÑπÔ∏è –û –±–æ—Ç–µ:\n\n"
        "–í–µ—Ä—Å–∏—è: 1.0\n"
        "–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞: AIOgram 3.x\n"
        "–†–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫: @username"
    )
```

---

## 5. –ú–∞—à–∏–Ω–∞ —Å–æ—Å—Ç–æ—è–Ω–∏–π (FSM)

### –ü—Ä–∏–º–µ—Ä –ø–æ—à–∞–≥–æ–≤–æ–≥–æ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º

FSM (Finite State Machine) –ø–æ–∑–≤–æ–ª—è–µ—Ç —Å–æ–∑–¥–∞–≤–∞—Ç—å –º–Ω–æ–≥–æ—à–∞–≥–æ–≤—ã–µ –¥–∏–∞–ª–æ–≥–∏ —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º.

–°–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª `states.py`:

```python
from aiogram.fsm.state import State, StatesGroup

class Form(StatesGroup):
    """–°–æ—Å—Ç–æ—è–Ω–∏—è –¥–ª—è —Ñ–æ—Ä–º—ã —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏"""
    name = State()
    age = State()
    city = State()
```

### –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏–π –∏ –ø–µ—Ä–µ—Ö–æ–¥–æ–≤

```python
from aiogram import Router, F
from aiogram.filters import Command
from aiogram.fsm.context import FSMContext
from aiogram.types import Message
from states import Form

router = Router()

@router.message(Command("register"))
async def cmd_register(message: Message, state: FSMContext):
    """–ù–∞—á–∞–ª–æ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏"""
    await message.answer("–ö–∞–∫ –≤–∞—Å –∑–æ–≤—É—Ç?")
    await state.set_state(Form.name)

@router.message(Form.name)
async def process_name(message: Message, state: FSMContext):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –∏–º–µ–Ω–∏"""
    await state.update_data(name=message.text)
    await message.answer("–°–∫–æ–ª—å–∫–æ –≤–∞–º –ª–µ—Ç?")
    await state.set_state(Form.age)

@router.message(Form.age, F.text.isdigit())
async def process_age(message: Message, state: FSMContext):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –≤–æ–∑—Ä–∞—Å—Ç–∞"""
    await state.update_data(age=int(message.text))
    await message.answer("–í –∫–∞–∫–æ–º –≥–æ—Ä–æ–¥–µ –≤—ã –∂–∏–≤—ë—Ç–µ?")
    await state.set_state(Form.city)

@router.message(Form.age)
async def process_age_invalid(message: Message):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–µ–≤–µ—Ä–Ω–æ–≥–æ –≤–æ–∑—Ä–∞—Å—Ç–∞"""
    await message.answer("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ —á–∏—Å–ª–æ")

@router.message(Form.city)
async def process_city(message: Message, state: FSMContext):
    """–ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏"""
    await state.update_data(city=message.text)
    
    # –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ –¥–∞–Ω–Ω—ã–µ
    data = await state.get_data()
    
    await message.answer(
        f"–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞!\n\n"
        f"–ò–º—è: {data['name']}\n"
        f"–í–æ–∑—Ä–∞—Å—Ç: {data['age']}\n"
        f"–ì–æ—Ä–æ–¥: {data['city']}"
    )
    
    # –û—á–∏—â–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
    await state.clear()

@router.message(Command("cancel"))
async def cmd_cancel(message: Message, state: FSMContext):
    """–û—Ç–º–µ–Ω–∞ —Ç–µ–∫—É—â–µ–≥–æ –¥–µ–π—Å—Ç–≤–∏—è"""
    current_state = await state.get_state()
    if current_state is None:
        await message.answer("–ù–µ—á–µ–≥–æ –æ—Ç–º–µ–Ω—è—Ç—å")
        return
    
    await state.clear()
    await message.answer("–î–µ–π—Å—Ç–≤–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ")
```

–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ FSM –≤ –≥–ª–∞–≤–Ω–æ–º —Ñ–∞–π–ª–µ:

```python
from aiogram.fsm.storage.memory import MemoryStorage

# –°–æ–∑–¥–∞—ë–º —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –¥–ª—è —Å–æ—Å—Ç–æ—è–Ω–∏–π
storage = MemoryStorage()
dp = Dispatcher(storage=storage)
```

---

## 6. –†–∞–±–æ—Ç–∞ —Å Inline-–∫–Ω–æ–ø–∫–∞–º–∏ –∏ –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞–º–∏

### –°–æ–∑–¥–∞–Ω–∏–µ –∏–Ω–ª–∞–π–Ω-–∫–Ω–æ–ø–æ–∫

```python
from aiogram import Router
from aiogram.filters import Command
from aiogram.types import Message, InlineKeyboardMarkup, InlineKeyboardButton

router = Router()

@router.message(Command("menu"))
async def cmd_menu(message: Message):
    """–ú–µ–Ω—é —Å –∏–Ω–ª–∞–π–Ω-–∫–Ω–æ–ø–∫–∞–º–∏"""
    keyboard = InlineKeyboardMarkup(
        inline_keyboard=[
            [
                InlineKeyboardButton(text="üîî –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è", callback_data="notifications"),
                InlineKeyboardButton(text="‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏", callback_data="settings")
            ],
            [
                InlineKeyboardButton(text="‚ÑπÔ∏è –ü–æ–º–æ—â—å", callback_data="help"),
                InlineKeyboardButton(text="üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞", callback_data="stats")
            ],
            [
                InlineKeyboardButton(text="üåê –°–∞–π—Ç", url="https://example.com")
            ]
        ]
    )
    
    await message.answer("–í—ã–±–µ—Ä–∏—Ç–µ –ø—É–Ω–∫—Ç –º–µ–Ω—é:", reply_markup=keyboard)
```

### –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ CallbackData –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –Ω–∞–∂–∞—Ç–∏–π

–°–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª `keyboards/callbacks.py`:

```python
from aiogram.filters.callback_data import CallbackData

class MenuCallback(CallbackData, prefix="menu"):
    """Callback –¥–ª—è –º–µ–Ω—é"""
    action: str
    page: int = 1

class ProductCallback(CallbackData, prefix="product"):
    """Callback –¥–ª—è —Ç–æ–≤–∞—Ä–æ–≤"""
    action: str
    product_id: int
```

–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ CallbackData:

```python
from aiogram import Router, F
from aiogram.types import Message, CallbackQuery, InlineKeyboardMarkup, InlineKeyboardButton
from keyboards.callbacks import MenuCallback, ProductCallback

router = Router()

@router.message(Command("catalog"))
async def cmd_catalog(message: Message):
    """–ö–∞—Ç–∞–ª–æ–≥ —Ç–æ–≤–∞—Ä–æ–≤"""
    keyboard = InlineKeyboardMarkup(
        inline_keyboard=[
            [
                InlineKeyboardButton(
                    text="–¢–æ–≤–∞—Ä 1",
                    callback_data=ProductCallback(action="view", product_id=1).pack()
                )
            ],
            [
                InlineKeyboardButton(
                    text="–¢–æ–≤–∞—Ä 2",
                    callback_data=ProductCallback(action="view", product_id=2).pack()
                )
            ],
            [
                InlineKeyboardButton(
                    text="‚óÄÔ∏è –ù–∞–∑–∞–¥",
                    callback_data=MenuCallback(action="back").pack()
                )
            ]
        ]
    )
    
    await message.answer("–ö–∞—Ç–∞–ª–æ–≥ —Ç–æ–≤–∞—Ä–æ–≤:", reply_markup=keyboard)

@router.callback_query(ProductCallback.filter(F.action == "view"))
async def process_product_view(callback: CallbackQuery, callback_data: ProductCallback):
    """–ü—Ä–æ—Å–º–æ—Ç—Ä —Ç–æ–≤–∞—Ä–∞"""
    product_id = callback_data.product_id
    
    keyboard = InlineKeyboardMarkup(
        inline_keyboard=[
            [
                InlineKeyboardButton(
                    text="üõí –í –∫–æ—Ä–∑–∏–Ω—É",
                    callback_data=ProductCallback(action="add_to_cart", product_id=product_id).pack()
                )
            ],
            [
                InlineKeyboardButton(
                    text="‚óÄÔ∏è –ö –∫–∞—Ç–∞–ª–æ–≥—É",
                    callback_data=MenuCallback(action="catalog").pack()
                )
            ]
        ]
    )
    
    await callback.message.edit_text(
        f"–¢–æ–≤–∞—Ä #{product_id}\n\n"
        f"–û–ø–∏—Å–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞...",
        reply_markup=keyboard
    )
    await callback.answer()

@router.callback_query(ProductCallback.filter(F.action == "add_to_cart"))
async def process_add_to_cart(callback: CallbackQuery, callback_data: ProductCallback):
    """–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤ –∫–æ—Ä–∑–∏–Ω—É"""
    product_id = callback_data.product_id
    await callback.answer(f"–¢–æ–≤–∞—Ä #{product_id} –¥–æ–±–∞–≤–ª–µ–Ω –≤ –∫–æ—Ä–∑–∏–Ω—É!", show_alert=True)
```

–û–±—ã—á–Ω—ã–µ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã (Reply Keyboard):

```python
from aiogram.types import ReplyKeyboardMarkup, KeyboardButton

@router.message(Command("keyboard"))
async def cmd_keyboard(message: Message):
    """–û–±—ã—á–Ω–∞—è –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞"""
    keyboard = ReplyKeyboardMarkup(
        keyboard=[
            [
                KeyboardButton(text="üì± –ü–æ–¥–µ–ª–∏—Ç—å—Å—è –∫–æ–Ω—Ç–∞–∫—Ç–æ–º", request_contact=True)
            ],
            [
                KeyboardButton(text="üìç –û—Ç–ø—Ä–∞–≤–∏—Ç—å –ª–æ–∫–∞—Ü–∏—é", request_location=True)
            ],
            [
                KeyboardButton(text="‚ùå –£–±—Ä–∞—Ç—å –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É")
            ]
        ],
        resize_keyboard=True,
        one_time_keyboard=True
    )
    
    await message.answer("–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:", reply_markup=keyboard)
```

---

## 7. –§–∏–ª—å—Ç—Ä—ã —Å–æ–æ–±—â–µ–Ω–∏–π

### –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã—Ö —Ñ–∏–ª—å—Ç—Ä–æ–≤

AIOgram 3.x –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –º–Ω–æ–∂–µ—Å—Ç–≤–æ –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã—Ö —Ñ–∏–ª—å—Ç—Ä–æ–≤:

```python
from aiogram import Router, F
from aiogram.filters import Command, CommandStart, StateFilter
from aiogram.types import Message

router = Router()

# –§–∏–ª—å—Ç—Ä –ø–æ –∫–æ–º–∞–Ω–¥–µ
@router.message(Command("start"))
async def cmd_start(message: Message):
    await message.answer("–ö–æ–º–∞–Ω–¥–∞ /start")

# –§–∏–ª—å—Ç—Ä –ø–æ —Ç–µ–∫—Å—Ç—É
@router.message(F.text == "–ü—Ä–∏–≤–µ—Ç")
async def hello(message: Message):
    await message.answer("–ü—Ä–∏–≤–µ—Ç!")

# –§–∏–ª—å—Ç—Ä –ø–æ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏—é —Ç–µ–∫—Å—Ç–∞
@router.message(F.text.contains("–±–æ—Ç"))
async def contains_bot(message: Message):
    await message.answer("–í—ã —É–ø–æ–º—è–Ω—É–ª–∏ –±–æ—Ç–∞!")

# –§–∏–ª—å—Ç—Ä –ø–æ —Ä–µ–≥—É–ª—è—Ä–Ω–æ–º—É –≤—ã—Ä–∞–∂–µ–Ω–∏—é
@router.message(F.text.regexp(r"\d{10}"))
async def phone_number(message: Message):
    await message.answer("–≠—Ç–æ –ø–æ—Ö–æ–∂–µ –Ω–∞ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞!")

# –§–∏–ª—å—Ç—Ä –ø–æ —Ç–∏–ø—É –∫–æ–Ω—Ç–µ–Ω—Ç–∞
@router.message(F.photo)
async def handle_photo(message: Message):
    await message.answer("–ü–æ–ª—É—á–µ–Ω–æ —Ñ–æ—Ç–æ")

@router.message(F.document)
async def handle_document(message: Message):
    await message.answer("–ü–æ–ª—É—á–µ–Ω –¥–æ–∫—É–º–µ–Ω—Ç")

# –§–∏–ª—å—Ç—Ä –ø–æ –Ω–µ—Å–∫–æ–ª—å–∫–∏–º —É—Å–ª–æ–≤–∏—è–º (AND)
@router.message(F.text, F.text.len() > 10)
async def long_text(message: Message):
    await message.answer("–î–ª–∏–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ!")

# –§–∏–ª—å—Ç—Ä –ø–æ –Ω–µ—Å–∫–æ–ª—å–∫–∏–º —É—Å–ª–æ–≤–∏—è–º (OR)
@router.message((F.photo) | (F.video))
async def media(message: Message):
    await message.answer("–ü–æ–ª—É—á–µ–Ω–æ –º–µ–¥–∏–∞")
```

### –ü—Ä–∏–º–µ—Ä —Å–æ–∑–¥–∞–Ω–∏—è –∫–∞—Å—Ç–æ–º–Ω–æ–≥–æ —Ñ–∏–ª—å—Ç—Ä–∞

–°–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª `filters/custom.py`:

```python
from aiogram.filters import BaseFilter
from aiogram.types import Message

class IsAdmin(BaseFilter):
    """–§–∏–ª—å—Ç—Ä –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–∞–≤ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞"""
    
    def __init__(self, admin_ids: list[int]):
        self.admin_ids = admin_ids
    
    async def __call__(self, message: Message) -> bool:
        return message.from_user.id in self.admin_ids

class HasLinks(BaseFilter):
    """–§–∏–ª—å—Ç—Ä –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–∞–ª–∏—á–∏—è —Å—Å—ã–ª–æ–∫"""
    
    async def __call__(self, message: Message) -> bool:
        if not message.text:
            return False
        
        return any(entity.type == "url" for entity in (message.entities or []))

class TextLength(BaseFilter):
    """–§–∏–ª—å—Ç—Ä –ø–æ –¥–ª–∏–Ω–µ —Ç–µ–∫—Å—Ç–∞"""
    
    def __init__(self, min_length: int = 0, max_length: int = None):
        self.min_length = min_length
        self.max_length = max_length
    
    async def __call__(self, message: Message) -> bool:
        if not message.text:
            return False
        
        text_len = len(message.text)
        
        if text_len < self.min_length:
            return False
        
        if self.max_length and text_len > self.max_length:
            return False
        
        return True
```

–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∫–∞—Å—Ç–æ–º–Ω—ã—Ö —Ñ–∏–ª—å—Ç—Ä–æ–≤:

```python
from aiogram import Router
from aiogram.types import Message
from filters.custom import IsAdmin, HasLinks, TextLength

router = Router()

ADMIN_IDS = [123456789, 987654321]

@router.message(IsAdmin(ADMIN_IDS))
async def admin_only(message: Message):
    """–¢–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤"""
    await message.answer("–ü—Ä–∏–≤–µ—Ç, –∞–¥–º–∏–Ω!")

@router.message(HasLinks())
async def has_links(message: Message):
    """–°–æ–æ–±—â–µ–Ω–∏—è —Å–æ —Å—Å—ã–ª–∫–∞–º–∏"""
    await message.answer("–û–±–Ω–∞—Ä—É–∂–µ–Ω–∞ —Å—Å—ã–ª–∫–∞ –≤ —Å–æ–æ–±—â–µ–Ω–∏–∏")

@router.message(TextLength(min_length=10, max_length=100))
async def medium_text(message: Message):
    """–°–æ–æ–±—â–µ–Ω–∏—è —Å—Ä–µ–¥–Ω–µ–π –¥–ª–∏–Ω—ã"""
    await message.answer("–°–æ–æ–±—â–µ–Ω–∏–µ —Å—Ä–µ–¥–Ω–µ–π –¥–ª–∏–Ω—ã –ø—Ä–∏–Ω—è—Ç–æ")
```

---

## 8. Middleware

### –ß—Ç–æ —Ç–∞–∫–æ–µ middleware –∏ –∑–∞—á–µ–º –æ–Ω–æ –Ω—É–∂–Ω–æ

**Middleware** ‚Äî —ç—Ç–æ –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–π —Å–ª–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏, –∫–æ—Ç–æ—Ä—ã–π –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –¥–æ –∏–ª–∏ –ø–æ—Å–ª–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞. –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è:
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
- –ü—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞
- –û–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫
- –°–±–æ—Ä–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
- –ú–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö

### –ü—Ä–∏–º–µ—Ä —Å–æ–∑–¥–∞–Ω–∏—è –∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è middleware

–°–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª `middlewares/logging.py`:

```python
from typing import Callable, Dict, Any, Awaitable
from aiogram import BaseMiddleware
from aiogram.types import Message
import logging

logger = logging.getLogger(__name__)

class LoggingMiddleware(BaseMiddleware):
    """Middleware –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π"""
    
    async def __call__(
        self,
        handler: Callable[[Message, Dict[str, Any]], Awaitable[Any]],
        event: Message,
        data: Dict[str, Any]
    ) -> Any:
        # –ö–æ–¥ –¥–æ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞
        logger.info(
            f"User {event.from_user.id} (@{event.from_user.username}): {event.text}"
        )
        
        # –í—ã–∑–æ–≤ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞
        result = await handler(event, data)
        
        # –ö–æ–¥ –ø–æ—Å–ª–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞
        logger.info(f"Handler executed successfully")
        
        return result
```

Middleware –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ–¥–ø–∏—Å–∫–∏:

```python
from typing import Callable, Dict, Any, Awaitable
from aiogram import BaseMiddleware
from aiogram.types import Message, InlineKeyboardMarkup, InlineKeyboardButton

class SubscriptionMiddleware(BaseMiddleware):
    """Middleware –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ–¥–ø–∏—Å–∫–∏ –Ω–∞ –∫–∞–Ω–∞–ª"""
    
    def __init__(self, channel_id: int):
        self.channel_id = channel_id
        super().__init__()
    
    async def __call__(
        self,
        handler: Callable[[Message, Dict[str, Any]], Awaitable[Any]],
        event: Message,
        data: Dict[str, Any]
    ) -> Any:
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–ø–∏—Å–∫—É
        try:
            member = await event.bot.get_chat_member(
                chat_id=self.channel_id,
                user_id=event.from_user.id
            )
            
            if member.status in ["left", "kicked"]:
                keyboard = InlineKeyboardMarkup(
                    inline_keyboard=[
                        [
                            InlineKeyboardButton(
                                text="–ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –∫–∞–Ω–∞–ª",
                                url=f"https://t.me/your_channel"
                            )
                        ]
                    ]
                )
                
                await event.answer(
                    "–î–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –±–æ—Ç–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –ø–æ–¥–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –∫–∞–Ω–∞–ª!",
                    reply_markup=keyboard
                )
                return
        except Exception as e:
            # –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º
            pass
        
        return await handler(event, data)
```

Middleware –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö:

```python
from typing import Callable, Dict, Any, Awaitable
from aiogram import BaseMiddleware
from aiogram.types import TelegramObject
import sqlite3

class DatabaseMiddleware(BaseMiddleware):
    """Middleware –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö"""
    
    def __init__(self, db_path: str):
        self.db_path = db_path
        super().__init__()
    
    async def __call__(
        self,
        handler: Callable[[TelegramObject, Dict[str, Any]], Awaitable[Any]],
        event: TelegramObject,
        data: Dict[str, Any]
    ) -> Any:
        # –°–æ–∑–¥–∞—ë–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –ë–î
        conn = sqlite3.connect(self.db_path)
        conn.row_factory = sqlite3.Row
        
        # –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –≤ data
        data['db'] = conn
        
        try:
            # –í—ã–∑—ã–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫
            result = await handler(event, data)
            conn.commit()
            return result
        finally:
            # –ó–∞–∫—Ä—ã–≤–∞–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
            conn.close()
```

–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ middleware:

```python
# bot.py
from aiogram import Bot, Dispatcher
from middlewares.logging import LoggingMiddleware
from middlewares.subscription import SubscriptionMiddleware
from middlewares.database import DatabaseMiddleware

bot = Bot(token=BOT_TOKEN)
dp = Dispatcher()

# –ü–æ–¥–∫–ª—é—á–∞–µ–º middleware
dp.message.middleware(LoggingMiddleware())
dp.message.middleware(SubscriptionMiddleware(channel_id=-1001234567890))
dp.message.middleware(DatabaseMiddleware(db_path="bot.db"))
```

---

## 9. –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö

### –ü—Ä–∏–º–µ—Ä –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ SQLite –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –±–æ—Ç–∞

–°–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª `database.py`:

```python
import sqlite3
import logging
from typing import Optional, List, Dict
from datetime import datetime

logger = logging.getLogger(__name__)

class Database:
    """–ö–ª–∞—Å—Å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö"""
    
    def __init__(self, db_path: str = "bot.db"):
        self.db_path = db_path
        self.init_db()
    
    def get_connection(self):
        """–ü–æ–ª—É—á–µ–Ω–∏–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –ë–î"""
        conn = sqlite3.connect(self.db_path)
        conn.row_factory = sqlite3.Row
        return conn
    
    def init_db(self):
        """–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö"""
        conn = self.get_connection()
        cursor = conn.cursor()
        
        # –¢–∞–±–ª–∏—Ü–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        cursor.execute('''
            CREATE TABLE IF NOT EXISTS users (
                user_id INTEGER PRIMARY KEY,
                username TEXT,
                first_name TEXT,
                last_name TEXT,
                is_premium INTEGER DEFAULT 0,
                balance INTEGER DEFAULT 0,
                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                last_activity TIMESTAMP DEFAULT CURRENT_TIMESTAMP
            )
        ''')
        
        # –¢–∞–±–ª–∏—Ü–∞ —Ç–æ–≤–∞—Ä–æ–≤
        cursor.execute('''
            CREATE TABLE IF NOT EXISTS products (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                name TEXT NOT NULL,
                description TEXT,
                price REAL NOT NULL,
                stock INTEGER DEFAULT 0,
                is_active INTEGER DEFAULT 1,
                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
            )
        ''')
        
        # –¢–∞–±–ª–∏—Ü–∞ –∑–∞–∫–∞–∑–æ–≤
        cursor.execute('''
            CREATE TABLE IF NOT EXISTS orders (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                user_id INTEGER NOT NULL,
                total_amount REAL NOT NULL,
                status TEXT DEFAULT 'pending',
                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                FOREIGN KEY (user_id) REFERENCES users (user_id)
            )
        ''')
        
        # –¢–∞–±–ª–∏—Ü–∞ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –∑–∞–∫–∞–∑–∞
        cursor.execute('''
            CREATE TABLE IF NOT EXISTS order_items (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                order_id INTEGER NOT NULL,
                product_id INTEGER NOT NULL,
                quantity INTEGER NOT NULL,
                price REAL NOT NULL,
                FOREIGN KEY (order_id) REFERENCES orders (id),
                FOREIGN KEY (product_id) REFERENCES products (id)
            )
        ''')
        
        conn.commit()
        conn.close()
        logger.info("Database initialized successfully")
    
    # –ú–µ—Ç–æ–¥—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏
    
    def add_user(self, user_id: int, username: str = None, 
                 first_name: str = None, last_name: str = None):
        """–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
        conn = self.get_connection()
        cursor = conn.cursor()
        
        try:
            cursor.execute('''
                INSERT INTO users (user_id, username, first_name, last_name)
                VALUES (?, ?, ?, ?)
            ''', (user_id, username, first_name, last_name))
            conn.commit()
            logger.info(f"User {user_id} added to database")
        except sqlite3.IntegrityError:
            # –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –æ–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
            cursor.execute('''
                UPDATE users 
                SET username = ?, first_name = ?, last_name = ?, last_activity = ?
                WHERE user_id = ?
            ''', (username, first_name, last_name, datetime.now(), user_id))
            conn.commit()
        finally:
            conn.close()
    
    def get_user(self, user_id: int) -> Optional[Dict]:
        """–ü–æ–ª—É—á–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ"""
        conn = self.get_connection()
        cursor = conn.cursor()
        
        cursor.execute('SELECT * FROM users WHERE user_id = ?', (user_id,))
        row = cursor.fetchone()
        conn.close()
        
        return dict(row) if row else None
    
    def update_user_balance(self, user_id: int, amount: int):
        """–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
        conn = self.get_connection()
        cursor = conn.cursor()
        
        cursor.execute('''
            UPDATE users SET balance = balance + ? WHERE user_id = ?
        ''', (amount, user_id))
        conn.commit()
        conn.close()
    
    # –ú–µ—Ç–æ–¥—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —Ç–æ–≤–∞—Ä–∞–º–∏
    
    def add_product(self, name: str, description: str, price: float, stock: int = 0):
        """–î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞"""
        conn = self.get_connection()
        cursor = conn.cursor()
        
        cursor.execute('''
            INSERT INTO products (name, description, price, stock)
            VALUES (?, ?, ?, ?)
        ''', (name, description, price, stock))
        conn.commit()
        product_id = cursor.lastrowid
        conn.close()
        
        return product_id
    
    def get_product(self, product_id: int) -> Optional[Dict]:
        """–ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞ –ø–æ ID"""
        conn = self.get_connection()
        cursor = conn.cursor()
        
        cursor.execute('SELECT * FROM products WHERE id = ?', (product_id,))
        row = cursor.fetchone()
        conn.close()
        
        return dict(row) if row else None
    
    def get_all_products(self) -> List[Dict]:
        """–ü–æ–ª—É—á–µ–Ω–∏–µ –≤—Å–µ—Ö –∞–∫—Ç–∏–≤–Ω—ã—Ö —Ç–æ–≤–∞—Ä–æ–≤"""
        conn = self.get_connection()
        cursor = conn.cursor()
        
        cursor.execute('SELECT * FROM products WHERE is_active = 1')
        rows = cursor.fetchall()
        conn.close()
        
        return [dict(row) for row in rows]
    
    # –ú–µ—Ç–æ–¥—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –∑–∞–∫–∞–∑–∞–º–∏
    
    def create_order(self, user_id: int, items: List[Dict]) -> int:
        """–°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –∑–∞–∫–∞–∑–∞"""
        conn = self.get_connection()
        cursor = conn.cursor()
        
        # –í—ã—á–∏—Å–ª—è–µ–º –æ–±—â—É—é —Å—É–º–º—É
        total_amount = sum(item['price'] * item['quantity'] for item in items)
        
        # –°–æ–∑–¥–∞—ë–º –∑–∞–∫–∞–∑
        cursor.execute('''
            INSERT INTO orders (user_id, total_amount)
            VALUES (?, ?)
        ''', (user_id, total_amount))
        order_id = cursor.lastrowid
        
        # –î–æ–±–∞–≤–ª—è–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã –∑–∞–∫–∞–∑–∞
        for item in items:
            cursor.execute('''
                INSERT INTO order_items (order_id, product_id, quantity, price)
                VALUES (?, ?, ?, ?)
            ''', (order_id, item['product_id'], item['quantity'], item['price']))
        
        conn.commit()
        conn.close()
        
        return order_id
    
    def get_user_orders(self, user_id: int) -> List[Dict]:
        """–ü–æ–ª—É—á–µ–Ω–∏–µ –∑–∞–∫–∞–∑–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
        conn = self.get_connection()
        cursor = conn.cursor()
        
        cursor.execute('''
            SELECT * FROM orders WHERE user_id = ? ORDER BY created_at DESC
        ''', (user_id,))
        rows = cursor.fetchall()
        conn.close()
        
        return [dict(row) for row in rows]
```

–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –≤ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞—Ö:

```python
from aiogram import Router
from aiogram.filters import CommandStart
from aiogram.types import Message
from database import Database

router = Router()
db = Database()

@router.message(CommandStart())
async def cmd_start(message: Message):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /start"""
    # –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –±–∞–∑—É
    db.add_user(
        user_id=message.from_user.id,
        username=message.from_user.username,
        first_name=message.from_user.first_name,
        last_name=message.from_user.last_name
    )
    
    # –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
    user = db.get_user(message.from_user.id)
    
    await message.answer(
        f"–ü—Ä–∏–≤–µ—Ç, {user['first_name']}!\n"
        f"–í–∞—à –±–∞–ª–∞–Ω—Å: {user['balance']} —Ä—É–±."
    )

@router.message(Command("products"))
async def cmd_products(message: Message):
    """–°–ø–∏—Å–æ–∫ —Ç–æ–≤–∞—Ä–æ–≤"""
    products = db.get_all_products()
    
    if not products:
        await message.answer("–¢–æ–≤–∞—Ä—ã –ø–æ–∫–∞ –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã")
        return
    
    text = "üì¶ –°–ø–∏—Å–æ–∫ —Ç–æ–≤–∞—Ä–æ–≤:\n\n"
    for product in products:
        text += (
            f"#{product['id']} {product['name']}\n"
            f"üí∞ {product['price']} —Ä—É–±.\n"
            f"üì¶ –í –Ω–∞–ª–∏—á–∏–∏: {product['stock']} —à—Ç.\n\n"
        )
    
    await message.answer(text)
```

---

## 10. –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫

### –ö–∞–∫ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

–°–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª `logger.py`:

```python
import logging
import sys
from datetime import datetime

def setup_logger(name: str = "bot", level: int = logging.INFO):
    """–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è"""
    
    # –°–æ–∑–¥–∞—ë–º –ª–æ–≥–≥–µ—Ä
    logger = logging.getLogger(name)
    logger.setLevel(level)
    
    # –§–æ—Ä–º–∞—Ç –ª–æ–≥–æ–≤
    formatter = logging.Formatter(
        '%(asctime)s - %(name)s - %(levelname)s - %(message)s',
        datefmt='%Y-%m-%d %H:%M:%S'
    )
    
    # –ö–æ–Ω—Å–æ–ª—å–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫
    console_handler = logging.StreamHandler(sys.stdout)
    console_handler.setLevel(level)
    console_handler.setFormatter(formatter)
    logger.addHandler(console_handler)
    
    # –§–∞–π–ª–æ–≤—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫
    file_handler = logging.FileHandler(
        f'logs/bot_{datetime.now().strftime("%Y%m%d")}.log',
        encoding='utf-8'
    )
    file_handler.setLevel(level)
    file_handler.setFormatter(formatter)
    logger.addHandler(file_handler)
    
    return logger
```

### –ü—Ä–∏–º–µ—Ä –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫

```python
from aiogram import Router
from aiogram.types import ErrorEvent
from aiogram.exceptions import TelegramBadRequest, TelegramForbiddenError
import logging

router = Router()
logger = logging.getLogger(__name__)

@router.error()
async def error_handler(event: ErrorEvent):
    """–ì–ª–æ–±–∞–ª—å–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—à–∏–±–æ–∫"""
    
    logger.error(f"Update: {event.update}")
    logger.error(f"Exception: {event.exception}")
    
    # –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö —Ç–∏–ø–æ–≤ –æ—à–∏–±–æ–∫
    if isinstance(event.exception, TelegramBadRequest):
        logger.error(f"Bad request: {event.exception}")
        # –ù–∞–ø—Ä–∏–º–µ—Ä, –ø–æ–ø—ã—Ç–∫–∞ –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å—Ç–∞—Ä–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
        
    elif isinstance(event.exception, TelegramForbiddenError):
        logger.error(f"Forbidden: {event.exception}")
        # –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–ª –±–æ—Ç–∞
        
    else:
        logger.exception(f"Unhandled exception: {event.exception}")
    
    return True  # –í–æ–∑–≤—Ä–∞—â–∞–µ–º True, —á—Ç–æ–±—ã –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ –æ—à–∏–±–∫–∏
```

–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –≤ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞—Ö:

```python
from aiogram import Router
from aiogram.types import Message
from aiogram.exceptions import TelegramAPIError
import logging

router = Router()
logger = logging.getLogger(__name__)

@router.message(Command("test"))
async def cmd_test(message: Message):
    """–¢–µ—Å—Ç–æ–≤–∞—è –∫–æ–º–∞–Ω–¥–∞ —Å –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –æ—à–∏–±–æ–∫"""
    try:
        # –í–∞—à –∫–æ–¥
        result = await some_dangerous_operation()
        await message.answer(f"–†–µ–∑—É–ª—å—Ç–∞—Ç: {result}")
        
    except TelegramAPIError as e:
        logger.error(f"Telegram API error: {e}")
        await message.answer("–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–∞–±–æ—Ç–µ —Å Telegram API")
        
    except ValueError as e:
        logger.error(f"Value error: {e}")
        await message.answer("–ù–µ–≤–µ—Ä–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ")
        
    except Exception as e:
        logger.exception(f"Unexpected error: {e}")
        await message.answer("–ü—Ä–æ–∏–∑–æ—à–ª–∞ –Ω–µ–ø—Ä–µ–¥–≤–∏–¥–µ–Ω–Ω–∞—è –æ—à–∏–±–∫–∞")
```

–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≤ –≥–ª–∞–≤–Ω–æ–º —Ñ–∞–π–ª–µ:

```python
# bot.py
import logging
from logger import setup_logger

# –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
logger = setup_logger("bot", level=logging.INFO)

# –í —Ñ—É–Ω–∫—Ü–∏–∏ main
async def main():
    logger.info("Starting bot...")
    
    try:
        await dp.start_polling(bot)
    except Exception as e:
        logger.exception(f"Fatal error: {e}")
    finally:
        logger.info("Bot stopped")
```

---

## 11. –†–∞–∑–≤—ë—Ä—Ç—ã–≤–∞–Ω–∏–µ –±–æ—Ç–∞

### –ó–∞–ø—É—Å–∫ –Ω–∞ –ª–æ–∫–∞–ª—å–Ω–æ–º —Å–µ—Ä–≤–µ—Ä–µ

–°–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª `.env`:

```env
BOT_TOKEN=your_bot_token_here
```

–ó–∞–ø—É—Å—Ç–∏—Ç–µ –±–æ—Ç–∞:

```bash
python bot.py
```

### –†–∞–∑–≤—ë—Ä—Ç—ã–≤–∞–Ω–∏–µ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º Docker

–°–æ–∑–¥–∞–π—Ç–µ `Dockerfile`:

```dockerfile
FROM python:3.11-slim

WORKDIR /app

# –ö–æ–ø–∏—Ä—É–µ–º —Ñ–∞–π–ª—ã –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
COPY requirements.txt .

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
RUN pip install --no-cache-dir -r requirements.txt

# –ö–æ–ø–∏—Ä—É–µ–º –∏—Å—Ö–æ–¥–Ω—ã–π –∫–æ–¥
COPY . .

# –°–æ–∑–¥–∞—ë–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –¥–ª—è –ª–æ–≥–æ–≤
RUN mkdir -p logs

# –ó–∞–ø—É—Å–∫–∞–µ–º –±–æ—Ç–∞
CMD ["python", "bot.py"]
```

–°–æ–∑–¥–∞–π—Ç–µ `docker-compose.yml`:

```yaml
version: '3.8'

services:
  bot:
    build: .
    container_name: telegram_bot
    restart: unless-stopped
    env_file:
      - .env
    volumes:
      - ./logs:/app/logs
      - ./bot.db:/app/bot.db
    environment:
      - PYTHONUNBUFFERED=1
```

–ö–æ–º–∞–Ω–¥—ã –¥–ª—è —Ä–∞–∑–≤—ë—Ä—Ç—ã–≤–∞–Ω–∏—è:

```bash
# –°–±–æ—Ä–∫–∞ –æ–±—Ä–∞–∑–∞
docker-compose build

# –ó–∞–ø—É—Å–∫
docker-compose up -d

# –ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤
docker-compose logs -f

# –û—Å—Ç–∞–Ω–æ–≤–∫–∞
docker-compose down
```

### –†–∞–∑–≤—ë—Ä—Ç—ã–≤–∞–Ω–∏–µ –Ω–∞ VPS

```bash
# –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–µ—Ä–≤–µ—Ä—É
ssh user@your-server-ip

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
sudo apt update
sudo apt install python3 python3-pip git

# –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞
git clone https://github.com/yourusername/your-bot.git
cd your-bot

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Python –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
pip3 install -r requirements.txt

# –°–æ–∑–¥–∞–Ω–∏–µ .env —Ñ–∞–π–ª–∞
nano .env
# –î–æ–±–∞–≤—å—Ç–µ BOT_TOKEN=your_token

# –°–æ–∑–¥–∞–Ω–∏–µ systemd —Å–µ—Ä–≤–∏—Å–∞
sudo nano /etc/systemd/system/telegram-bot.service
```

–°–æ–¥–µ—Ä–∂–∏–º–æ–µ `telegram-bot.service`:

```ini
[Unit]
Description=Telegram Bot
After=network.target

[Service]
Type=simple
User=your-user
WorkingDirectory=/home/your-user/your-bot
ExecStart=/usr/bin/python3 /home/your-user/your-bot/bot.py
Restart=always
RestartSec=10

[Install]
WantedBy=multi-user.target
```

–ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–∏—Å–∞:

```bash
# –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ systemd
sudo systemctl daemon-reload

# –í–∫–ª—é—á–µ–Ω–∏–µ –∞–≤—Ç–æ–∑–∞–ø—É—Å–∫–∞
sudo systemctl enable telegram-bot

# –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞
sudo systemctl start telegram-bot

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞
sudo systemctl status telegram-bot

# –ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤
sudo journalctl -u telegram-bot -f
```

---

## 12. –ü—Ä–∏–º–µ—Ä—ã –≥–æ—Ç–æ–≤—ã—Ö –±–æ—Ç–æ–≤

### –≠—Ö–æ-–±–æ—Ç

–ü—Ä–æ—Å—Ç–æ–π –±–æ—Ç, –∫–æ—Ç–æ—Ä—ã–π –ø–æ–≤—Ç–æ—Ä—è–µ—Ç –≤—Å–µ –ø–æ–ª—É—á–µ–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è:

```python
import asyncio
import logging
from aiogram import Bot, Dispatcher, Router, F
from aiogram.filters import CommandStart
from aiogram.types import Message
from config import BOT_TOKEN

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
logging.basicConfig(level=logging.INFO)

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
bot = Bot(token=BOT_TOKEN)
dp = Dispatcher()
router = Router()

@router.message(CommandStart())
async def cmd_start(message: Message):
    """–ö–æ–º–∞–Ω–¥–∞ /start"""
    await message.answer(
        "üëã –ü—Ä–∏–≤–µ—Ç! –Ø —ç—Ö–æ-–±–æ—Ç.\n"
        "–û—Ç–ø—Ä–∞–≤—å –º–Ω–µ –ª—é–±–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ, –∏ —è –ø–æ–≤—Ç–æ—Ä—é –µ–≥–æ!"
    )

@router.message(F.text)
async def echo_text(message: Message):
    """–ü–æ–≤—Ç–æ—Ä —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π"""
    await message.answer(message.text)

@router.message(F.photo)
async def echo_photo(message: Message):
    """–ü–æ–≤—Ç–æ—Ä —Ñ–æ—Ç–æ"""
    await message.answer_photo(
        photo=message.photo[-1].file_id,
        caption=message.caption or "–ü–æ–ª—É—á–µ–Ω–æ —Ñ–æ—Ç–æ"
    )

@router.message()
async def echo_other(message: Message):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –¥—Ä—É–≥–∏—Ö —Ç–∏–ø–æ–≤ —Å–æ–æ–±—â–µ–Ω–∏–π"""
    await message.answer("–ù–µ –º–æ–≥—É –ø–æ–≤—Ç–æ—Ä–∏—Ç—å —ç—Ç–æ—Ç —Ç–∏–ø —Å–æ–æ–±—â–µ–Ω–∏—è")

async def main():
    dp.include_router(router)
    await dp.start_polling(bot)

if __name__ == "__main__":
    asyncio.run(main())
```

### –ë–æ—Ç —Å –º–µ–Ω—é –∏ –∫–Ω–æ–ø–∫–∞–º–∏

–ü–æ–ª–Ω–æ—Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π –±–æ—Ç —Å –º–µ–Ω—é, –∫–Ω–æ–ø–∫–∞–º–∏ –∏ —Ä–∞–∑–ª–∏—á–Ω—ã–º–∏ —Ñ—É–Ω–∫—Ü–∏—è–º–∏:

```python
import asyncio
import logging
from datetime import datetime
from aiogram import Bot, Dispatcher, Router, F
from aiogram.filters import CommandStart, Command
from aiogram.types import Message, CallbackQuery
from aiogram.types import InlineKeyboardMarkup, InlineKeyboardButton
from aiogram.types import ReplyKeyboardMarkup, KeyboardButton
from config import BOT_TOKEN

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
bot = Bot(token=BOT_TOKEN)
dp = Dispatcher()
router = Router()

# –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∫–ª–∞–≤–∏–∞—Ç—É—Ä

def get_main_menu():
    """–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é"""
    keyboard = InlineKeyboardMarkup(
        inline_keyboard=[
            [
                InlineKeyboardButton(text="‚ÑπÔ∏è –û –±–æ—Ç–µ", callback_data="about"),
                InlineKeyboardButton(text="üéÆ –ò–≥—Ä—ã", callback_data="games")
            ],
            [
                InlineKeyboardButton(text="üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞", callback_data="stats"),
                InlineKeyboardButton(text="‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏", callback_data="settings")
            ],
            [
                InlineKeyboardButton(text="üìû –ü–æ–¥–¥–µ—Ä–∂–∫–∞", callback_data="support")
            ]
        ]
    )
    return keyboard

def get_games_menu():
    """–ú–µ–Ω—é –∏–≥—Ä"""
    keyboard = InlineKeyboardMarkup(
        inline_keyboard=[
            [
                InlineKeyboardButton(text="üé≤ –ö–æ—Å—Ç–∏", callback_data="game_dice"),
                InlineKeyboardButton(text="üéØ –î–∞—Ä—Ç—Å", callback_data="game_darts")
            ],
            [
                InlineKeyboardButton(text="üèÄ –ë–∞—Å–∫–µ—Ç–±–æ–ª", callback_data="game_basketball"),
                InlineKeyboardButton(text="‚öΩ –§—É—Ç–±–æ–ª", callback_data="game_football")
            ],
            [
                InlineKeyboardButton(text="‚óÄÔ∏è –ù–∞–∑–∞–¥", callback_data="back_to_main")
            ]
        ]
    )
    return keyboard

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–æ–º–∞–Ω–¥

@router.message(CommandStart())
async def cmd_start(message: Message):
    """–ö–æ–º–∞–Ω–¥–∞ /start"""
    await message.answer(
        f"üëã –ü—Ä–∏–≤–µ—Ç, {message.from_user.first_name}!\n\n"
        "–Ø –º–Ω–æ–≥–æ—Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π –±–æ—Ç —Å –º–µ–Ω—é –∏ –∫–Ω–æ–ø–∫–∞–º–∏.\n"
        "–í—ã–±–µ—Ä–∏ –ø—É–Ω–∫—Ç –º–µ–Ω—é:",
        reply_markup=get_main_menu()
    )

@router.message(Command("menu"))
async def cmd_menu(message: Message):
    """–ö–æ–º–∞–Ω–¥–∞ /menu"""
    await message.answer(
        "üìã –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é:",
        reply_markup=get_main_menu()
    )

@router.message(Command("help"))
async def cmd_help(message: Message):
    """–ö–æ–º–∞–Ω–¥–∞ /help"""
    help_text = """
üìñ –î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:

/start - –ù–∞—á–∞—Ç—å —Ä–∞–±–æ—Ç—É —Å –±–æ—Ç–æ–º
/menu - –û—Ç–∫—Ä—ã—Ç—å –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é
/help - –ü–æ–∫–∞–∑–∞—Ç—å —ç—Ç—É —Å–ø—Ä–∞–≤–∫—É
/about - –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –±–æ—Ç–µ

–ò—Å–ø–æ–ª—å–∑—É–π –∫–Ω–æ–ø–∫–∏ –¥–ª—è –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ –ø–æ –±–æ—Ç—É!
    """
    await message.answer(help_text)

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ callback

@router.callback_query(F.data == "about")
async def callback_about(callback: CallbackQuery):
    """–û –±–æ—Ç–µ"""
    about_text = """
‚ÑπÔ∏è –û –±–æ—Ç–µ:

–í–µ—Ä—Å–∏—è: 1.0
–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞: AIOgram 3.x
–Ø–∑—ã–∫: Python 3.11+

–í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:
‚Ä¢ –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ–µ –º–µ–Ω—é
‚Ä¢ –í—Å—Ç—Ä–æ–µ–Ω–Ω—ã–µ –∏–≥—Ä—ã
‚Ä¢ –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
‚Ä¢ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    """
    
    keyboard = InlineKeyboardMarkup(
        inline_keyboard=[
            [InlineKeyboardButton(text="‚óÄÔ∏è –ù–∞–∑–∞–¥", callback_data="back_to_main")]
        ]
    )
    
    await callback.message.edit_text(about_text, reply_markup=keyboard)
    await callback.answer()

@router.callback_query(F.data == "games")
async def callback_games(callback: CallbackQuery):
    """–ú–µ–Ω—é –∏–≥—Ä"""
    await callback.message.edit_text(
        "üéÆ –í—ã–±–µ—Ä–∏ –∏–≥—Ä—É:",
        reply_markup=get_games_menu()
    )
    await callback.answer()

@router.callback_query(F.data.startswith("game_"))
async def callback_game(callback: CallbackQuery):
    """–ó–∞–ø—É—Å–∫ –∏–≥—Ä—ã"""
    game = callback.data.split("_")[1]
    
    game_emoji = {
        "dice": "üé≤",
        "darts": "üéØ",
        "basketball": "ÔøΩÔøΩ",
        "football": "‚öΩ"
    }
    
    emoji = game_emoji.get(game, "üéÆ")
    
    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∏–≥—Ä–æ–≤–æ–π —ç–ª–µ–º–µ–Ω—Ç
    if game == "dice":
        result = await callback.message.answer_dice(emoji)
    elif game == "darts":
        result = await callback.message.answer_dice(emoji)
    elif game == "basketball":
        result = await callback.message.answer_dice(emoji)
    elif game == "football":
        result = await callback.message.answer_dice(emoji)
    
    await callback.answer(f"–ò–≥—Ä–∞ {emoji} –∑–∞–ø—É—â–µ–Ω–∞!")

@router.callback_query(F.data == "stats")
async def callback_stats(callback: CallbackQuery):
    """–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞"""
    stats_text = f"""
üìä –í–∞—à–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:

üë§ ID: {callback.from_user.id}
üìù Username: @{callback.from_user.username or '–Ω–µ —É–∫–∞–∑–∞–Ω'}
ÔøΩÔøΩ –î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏: {datetime.now().strftime('%d.%m.%Y')}
üí¨ –°–æ–æ–±—â–µ–Ω–∏–π –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ: 42
üéÆ –ò–≥—Ä —Å—ã–≥—Ä–∞–Ω–æ: 15
    """
    
    keyboard = InlineKeyboardMarkup(
        inline_keyboard=[
            [InlineKeyboardButton(text="‚óÄÔ∏è –ù–∞–∑–∞–¥", callback_data="back_to_main")]
        ]
    )
    
    await callback.message.edit_text(stats_text, reply_markup=keyboard)
    await callback.answer()

@router.callback_query(F.data == "settings")
async def callback_settings(callback: CallbackQuery):
    """–ù–∞—Å—Ç—Ä–æ–π–∫–∏"""
    keyboard = InlineKeyboardMarkup(
        inline_keyboard=[
            [
                InlineKeyboardButton(text="üîî –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è", callback_data="notif"),
                InlineKeyboardButton(text="üåê –Ø–∑—ã–∫", callback_data="lang")
            ],
            [
                InlineKeyboardButton(text="‚óÄÔ∏è –ù–∞–∑–∞–¥", callback_data="back_to_main")
            ]
        ]
    )
    
    await callback.message.edit_text(
        "‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏:",
        reply_markup=keyboard
    )
    await callback.answer()

@router.callback_query(F.data == "support")
async def callback_support(callback: CallbackQuery):
    """–ü–æ–¥–¥–µ—Ä–∂–∫–∞"""
    support_text = """
üìû –ü–æ–¥–¥–µ—Ä–∂–∫–∞:

–ï—Å–ª–∏ —É –≤–∞—Å –≤–æ–∑–Ω–∏–∫–ª–∏ –≤–æ–ø—Ä–æ—Å—ã –∏–ª–∏ –ø—Ä–æ–±–ª–µ–º—ã:

üìß Email: support@example.com
üí¨ Telegram: @support
üåê –°–∞–π—Ç: https://example.com

–ú—ã –æ—Ç–≤–µ—Ç–∏–º –≤ —Ç–µ—á–µ–Ω–∏–µ 24 —á–∞—Å–æ–≤!
    """
    
    keyboard = InlineKeyboardMarkup(
        inline_keyboard=[
            [InlineKeyboardButton(text="‚óÄÔ∏è –ù–∞–∑–∞–¥", callback_data="back_to_main")]
        ]
    )
    
    await callback.message.edit_text(support_text, reply_markup=keyboard)
    await callback.answer()

@router.callback_query(F.data == "back_to_main")
async def callback_back(callback: CallbackQuery):
    """–í–æ–∑–≤—Ä–∞—Ç –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é"""
    await callback.message.edit_text(
        "üìã –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é:",
        reply_markup=get_main_menu()
    )
    await callback.answer()

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π

@router.message(F.text)
async def handle_text(message: Message):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–µ–∫—Å—Ç–∞"""
    text = message.text.lower()
    
    if "–ø—Ä–∏–≤–µ—Ç" in text:
        await message.answer("üëã –ü—Ä–∏–≤–µ—Ç! –ò—Å–ø–æ–ª—å–∑—É–π /menu –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è –º–µ–Ω—é")
    elif "–∫–∞–∫ –¥–µ–ª–∞" in text:
        await message.answer("–û—Ç–ª–∏—á–Ω–æ! –ê —É —Ç–µ–±—è? üòä")
    else:
        await message.answer(
            "–Ø —Ç–µ–±—è –Ω–µ –ø–æ–Ω–∏–º–∞—é üòî\n–ò—Å–ø–æ–ª—å–∑—É–π /help –¥–ª—è —Å–ø—Ä–∞–≤–∫–∏"
        )

async def main():
    """–ì–ª–∞–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è"""
    dp.include_router(router)
    logger.info("Bot started")
    
    try:
        await dp.start_polling(bot)
    finally:
        await bot.session.close()

if __name__ == "__main__":
    asyncio.run(main())
```

---

## üìö –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ä–µ—Å—É—Ä—Å—ã

### –û—Ñ–∏—Ü–∏–∞–ª—å–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
- [AIOgram 3.x Documentation](https://docs.aiogram.dev/en/latest/)
- [Telegram Bot API](https://core.telegram.org/bots/api)

### –ü—Ä–∏–º–µ—Ä—ã –∏ —Ç—É—Ç–æ—Ä–∏–∞–ª—ã
- [AIOgram Examples](https://github.com/aiogram/aiogram/tree/dev-3.x/examples)
- [Telegram Bot API Updates](https://core.telegram.org/bots/api#recent-changes)

### –°–æ–æ–±—â–µ—Å—Ç–≤–æ
- [AIOgram Community](https://t.me/aiogram)
- [Stack Overflow](https://stackoverflow.com/questions/tagged/aiogram)

---

## üéØ –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

–≠—Ç–æ—Ç –≥–∞–π–¥ –æ—Ö–≤–∞—Ç—ã–≤–∞–µ—Ç –≤—Å–µ –æ—Å–Ω–æ–≤–Ω—ã–µ –∞—Å–ø–µ–∫—Ç—ã —Ä–∞–±–æ—Ç—ã —Å AIOgram 3.x. –¢–µ–ø–µ—Ä—å –≤—ã –∑–Ω–∞–µ—Ç–µ:

‚úÖ –ö–∞–∫ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∏ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å AIOgram  
‚úÖ –ö–∞–∫ —Å–æ–∑–¥–∞—Ç—å –∏ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å –±–æ—Ç–∞  
‚úÖ –ö–∞–∫ —Ä–∞–±–æ—Ç–∞—Ç—å —Å –¥–∏—Å–ø–µ—Ç—á–µ—Ä–æ–º –∏ —Ä–æ—É—Ç–µ—Ä–∞–º–∏  
‚úÖ –ö–∞–∫ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è –∏ –∫–æ–º–∞–Ω–¥—ã  
‚úÖ –ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å FSM –¥–ª—è –º–Ω–æ–≥–æ—à–∞–≥–æ–≤—ã—Ö –¥–∏–∞–ª–æ–≥–æ–≤  
‚úÖ –ö–∞–∫ —Å–æ–∑–¥–∞–≤–∞—Ç—å –∫–Ω–æ–ø–∫–∏ –∏ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã  
‚úÖ –ö–∞–∫ —Ñ–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è  
‚úÖ –ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å middleware  
‚úÖ –ö–∞–∫ —Ä–∞–±–æ—Ç–∞—Ç—å —Å –±–∞–∑–∞–º–∏ –¥–∞–Ω–Ω—ã—Ö  
‚úÖ –ö–∞–∫ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –æ–±—Ä–∞–±–æ—Ç–∫—É –æ—à–∏–±–æ–∫  
‚úÖ –ö–∞–∫ —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—å –±–æ—Ç–∞ –Ω–∞ —Ä–∞–∑–Ω—ã—Ö –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞—Ö  

–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø—Ä–∏–º–µ—Ä—ã –∏–∑ —ç—Ç–æ–≥–æ –≥–∞–π–¥–∞ –∫–∞–∫ –æ—Å–Ω–æ–≤—É –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Å–≤–æ–∏—Ö –±–æ—Ç–æ–≤. –£–¥–∞—á–∏ –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ! üöÄ

**–í–µ—Ä—Å–∏—è –≥–∞–π–¥–∞:** 1.0  
**–î–∞—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:** 2025-01-21  
**AIOgram –≤–µ—Ä—Å–∏—è:** 3.3.0
